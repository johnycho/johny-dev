---
slug: spring-cloud-config-decrypt
title: Spring Cloud Configμ λ³µνΈν™” μ‹¤ν¨ μ²λ¦¬ κ³Όμ • β€” {cipher}...κ°€ invalid.*λ΅ λ°”λ€λ” μ΄μ 
authors: [ johnycho ]
tags: [ spring ]
---

# π§© Spring Cloud Configμ λ³µνΈν™” μ‹¤ν¨ μ²λ¦¬ κ³Όμ • β€” {cipher}...κ°€ invalid.*λ΅ λ°”λ€λ” μ΄μ 
Spring Cloud Config Serverλ¥Ό μ“°λ‹¤ λ³΄λ©΄,
μ•”νΈν™”λ μ„¤μ •κ°’ `{cipher}...`κ°€ λ³µνΈν™”μ— μ‹¤ν¨ν•λ©΄μ„ `invalid.my.secret` ν•νƒλ΅ λ…Έμ¶λκ³ ,
κ²°κµ­ λ΅μ»¬ `application.properties`μ κ°’μ΄ μ μ©λλ” κ±Έ λ³Έ μ μ΄ μμ„ κ²λ‹λ‹¤.

μ¤λμ€ κ·Έ λ‚΄λ¶€ λ©”μ»¤λ‹μ¦μ„ μ½”μ–΄ μ½”λ“ λ λ²¨μ—μ„κΉμ§€ λ―μ–΄λ³΄λ ¤ ν•©λ‹λ‹¤.

## μ•”νΈν™”λ μ„¤μ •μ΄ μ„λ²„μ— μ „λ‹¬λλ” κµ¬μ΅°
Config Serverλ” Git, FileSystem, Vault λ“±μ—μ„ μ„¤μ • νμΌμ„ μ½κ³ ,
`EnvironmentRepository.findOne()`μ„ ν†µν•΄ ν΄λΌμ΄μ–ΈνΈμ— `Environment` κ°μ²΄(JSON)λ¥Ό λ°ν™ν•©λ‹λ‹¤.

μ΄λ• μ„¤μ •κ°’ μ¤‘ `{cipher}...`λ΅ μ‹μ‘ν•λ” ν•­λ©μ΄ μμΌλ©΄  
`EnvironmentController` β†’ `EnvironmentRepository` β†’ `EnvironmentEncryptor.decrypt()`
λ‹¨κ³„λ¥Ό κ±°μΉλ©° λ³µνΈν™”λ¥Ό μ‹λ„ν•©λ‹λ‹¤.
```java
// EnvironmentEncryptorEnvironmentRepository.java
@Override
public Environment findOne(String name, String profiles, String label, boolean includeOrigin) {
    Environment environment = this.delegate.findOne(name, profiles, label, includeOrigin);
    if (this.environmentEncryptors != null) {
        for (EnvironmentEncryptor environmentEncryptor : environmentEncryptors) {
            environment = environmentEncryptor.decrypt(environment);
        }
    }
    if (!this.overrides.isEmpty()) {
        environment.addFirst(new PropertySource("overrides", getOverridesMap(includeOrigin)));
    }
    return environment;
}
```
κΈ°λ³Έμ μΌλ΅ μ•„λ λ‘ κ°μ `EnvironmentEncryptor`κ°€ μ΅΄μ¬ν•©λ‹λ‹¤.
* `CipherEnvironmentEncryptor` (κΈ°λ³Έ RSA/Key κΈ°λ° λ³µνΈν™”)
* `VaultEnvironmentEncryptor` (HashiCorp Vault μ—°λ™ μ‹)

## λ³µνΈν™” μ‹¤ν¨ μ‹ `invalid.*` ν‚¤λ΅ λ¬΄ν¨ν™” μ²λ¦¬
`CipherEnvironmentEncryptor.decrypt()` λ‚΄λ¶€λ¥Ό λ³΄λ©΄,
κ° `PropertySource`μ ν‚¤/κ°’μ„ μνν•λ©° `{cipher}` μ ‘λ‘μ–΄κ°€ λ¶™μ€ ν•­λ©μ„ λ³µνΈν™”ν•©λ‹λ‹¤.

λ³µνΈν™” μ¤‘ μμ™Έ(`EncryptionOperationNotPossibleException`)κ°€ λ°μƒν•λ©΄ λ‹¤μκ³Ό κ°™μ΄ μ²λ¦¬λ©λ‹λ‹¤.
```java
// CipherEnvironmentEncryptor.decrypt() μ½”λ“ μ”μ•½
catch (Exception e){
    if(this.prefixInvalidProperties) {
        value = "<n/a>";
        name = "invalid." + name;
    }
    String message = "Cannot decrypt key: " + key + " (" + e.getClass() + ": " + e.getMessage() + ")";
}
map.put(name, value);
```
μ¦‰, μ›λ ν‚¤ `my.secret` λ€μ‹  `invalid.my.secret`μ΄ μ¶”κ°€λ©λ‹λ‹¤.  
μ΄λ• κΈ°μ΅΄ `my.secret` ν‚¤λ” μ΅΄μ¬ν•μ§€ μ•μΌλ―€λ΅, Config Clientλ” μ΄ κ°’μ„ λ¬΄μ‹ν•κ² λ©λ‹λ‹¤.

## ν΄λΌμ΄μ–ΈνΈμ—μ„ `invalid.*` κ°€ λ¬΄μ‹λλ” μ΄μ 
Config Clientκ°€ μ„λ²„λ΅λ¶€ν„° λ°›μ€ μ„¤μ •μ„ `Environment`λ΅ λ¨Έμ§€ν•  λ•,
`PropertySourcesPropertyResolver`κ°€ μμ„λ€λ΅ `PropertySource`λ¥Ό μνν•λ©° κ°’μ„ μ°Ύμµλ‹λ‹¤.
1.	λ¨Όμ € `configserver:*` `PropertySource`λ¥Ό νƒμƒ‰
2.	`{cipher}` λ³µνΈν™” μ‹¤ν¨ β†’ `invalid.my.secret`λ§ μ΅΄μ¬
3.	μ°Ύμ§€ λ»ν•λ©΄ λ‹¤μ `PropertySource` (λ΅μ»¬ νμΌ λ“±)λ΅ fall-through
4.	`application.properties`μ—μ„ `my.secret=localValue` λ°κ²¬ β†’ λ°ν™ β…

μ¦‰, `invalid.*` ν‚¤λ” <mark>**λ‹¨μ§€ μ‹¤ν¨ ν”μ μΌ λΏ**</mark>, `Environment`μ—μ„λ” <mark>**μ°Έμ΅°λμ§€ μ•μµλ‹λ‹¤.**</mark>

μ΄ λ™μ‘μ€ `AbstractEnvironment` λ‚΄λ¶€μ—μ„ mergeλ  λ•, λ‹¨μν `PropertySource` μμ„λ€λ΅ λ¶™κΈ° λ•λ¬Έμ—
νΉλ³„ν• μμ™Έμ²λ¦¬ μ—†μ΄ <mark>β€λ’¤μ— μ¤λ” `PropertySource`κ°€ μ°μ„ κ¶μ„ κ°€μ§„λ‹¤β€</mark>λ” μΌλ° κ·μΉ™μΌλ΅ ν•΄κ²°λ©λ‹λ‹¤.