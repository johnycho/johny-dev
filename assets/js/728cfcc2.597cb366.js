"use strict";(self.webpackChunkjohnycho_dev=self.webpackChunkjohnycho_dev||[]).push([[9109],{8820:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>g,frontMatter:()=>i,metadata:()=>a,toc:()=>d});const a=JSON.parse('{"permalink":"/blog/redis-distributed-lock","source":"@site/blog/2025-06-06-kafka-distributed-tracing.mdx","title":"Kafka Producer/Consumer TraceId \ubd88\uc77c\uce58 \ubb38\uc81c \ud574\uacb0\uae30 (with OpenTelemetry)","description":"Spring Kafka\ub97c \uc0ac\uc6a9\ud558\ub294 \ub9c8\uc774\ud06c\ub85c\uc11c\ube44\uc2a4 \ud658\uacbd\uc5d0\uc11c, Kafka \uba54\uc2dc\uc9c0\ub97c \ud504\ub85c\ub4c0\uc11c\uc5d0\uc11c \ubcf4\ub0b4\uace0 \ucee8\uc288\uba38\uc5d0\uc11c \ubc1b\uc744 \ub54c \uc11c\ub85c \ub2e4\ub978 traceId\ub85c \uae30\ub85d\ub418\ub294 \uc774\uc288\uac00 \uc788\uc5c8\uc2b5\ub2c8\ub2e4.","date":"2025-06-06T00:00:00.000Z","tags":[{"inline":false,"label":"Kafka","permalink":"/blog/tags/kafka","description":"Kafka tag description"},{"inline":false,"label":"OpenTelemetry","permalink":"/blog/tags/open-telemetry","description":"OpenTelemetry tag description"}],"readingTime":8.86,"hasTruncateMarker":true,"authors":[{"name":"Johny Cho","title":"Back End Engineer @ NHN","url":"https://github.com/johnycho","page":{"permalink":"/blog/authors/johnycho"},"socials":{"github":"https://github.com/johnycho","instagram":"https://www.instagram.com/johny__cho","linkedin":"https://www.linkedin.com/in/johny-cho/"},"imageURL":"https://github.com/johnycho.png","key":"johnycho"}],"frontMatter":{"slug":"redis-distributed-lock","title":"Kafka Producer/Consumer TraceId \ubd88\uc77c\uce58 \ubb38\uc81c \ud574\uacb0\uae30 (with OpenTelemetry)","authors":["johnycho"],"tags":["kafka","open-telemetry"]},"unlisted":false,"nextItem":{"title":"Redis Spin Lock\uc5d0\uc11c Redisson \uae30\ubc18 \ubd84\uc0b0\ub77d\uc73c\ub85c \uac1c\uc120\ud558\uae30","permalink":"/blog/redis-distributed-lock"}}');var s=r(4848),t=r(8453);const i={slug:"redis-distributed-lock",title:"Kafka Producer/Consumer TraceId \ubd88\uc77c\uce58 \ubb38\uc81c \ud574\uacb0\uae30 (with OpenTelemetry)",authors:["johnycho"],tags:["kafka","open-telemetry"]},c=void 0,l={authorsImageUrls:[void 0]},d=[{value:"\uae30\uc874 \ucf54\ub4dc",id:"\uae30\uc874-\ucf54\ub4dc",level:2},{value:"\ubb38\uc81c\uc810 1",id:"\ubb38\uc81c\uc810-1",level:3},{value:"\ubb38\uc81c\uc810 2",id:"\ubb38\uc81c\uc810-2",level:3},{value:"\ud574\uacb0 \ubc29\ubc95",id:"\ud574\uacb0-\ubc29\ubc95",level:2},{value:"\uad6c\ud604 \uc0c1\uc138",id:"\uad6c\ud604-\uc0c1\uc138",level:2},{value:"1. MessageConsumer \uc778\ud130\ud398\uc774\uc2a4",id:"1-messageconsumer-\uc778\ud130\ud398\uc774\uc2a4",level:3},{value:"2. OpenTelemetryKafkaTracer",id:"2-opentelemetrykafkatracer",level:3},{value:"3. OpenTelemetryKafkaExtractor",id:"3-opentelemetrykafkaextractor",level:3},{value:"\uc2e4\uc81c \uc801\uc6a9 \uc608\uc2dc",id:"\uc2e4\uc81c-\uc801\uc6a9-\uc608\uc2dc",level:2},{value:"\ub3d9\uc791 \ud750\ub984",id:"\ub3d9\uc791-\ud750\ub984",level:3},{value:"\ub9c8\uce58\uba70",id:"\ub9c8\uce58\uba70",level:2}];function o(e){const n={br:"br",code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("br",{}),"\n",(0,s.jsx)("br",{}),"\n",(0,s.jsxs)(n.p,{children:["Spring Kafka\ub97c \uc0ac\uc6a9\ud558\ub294 \ub9c8\uc774\ud06c\ub85c\uc11c\ube44\uc2a4 \ud658\uacbd\uc5d0\uc11c, Kafka \uba54\uc2dc\uc9c0\ub97c \ud504\ub85c\ub4c0\uc11c\uc5d0\uc11c \ubcf4\ub0b4\uace0 \ucee8\uc288\uba38\uc5d0\uc11c \ubc1b\uc744 \ub54c ",(0,s.jsx)("mark",{children:"\uc11c\ub85c \ub2e4\ub978 traceId"}),"\ub85c \uae30\ub85d\ub418\ub294 \uc774\uc288\uac00 \uc788\uc5c8\uc2b5\ub2c8\ub2e4.\n\uc774\ubc88 \ud3ec\uc2a4\ud2b8\uc5d0\uc11c\ub294 \ud574\ub2f9 \uc774\uc288\uac00 \ubc1c\uc0dd\ud55c \uc6d0\uc778\uacfc \ud574\uacb0 \uacfc\uc815\uc5d0 \ub300\ud574\uc11c \uacf5\uc720\ud558\uace0\uc790 \ud569\ub2c8\ub2e4."]}),"\n",(0,s.jsx)(n.h2,{id:"\uae30\uc874-\ucf54\ub4dc",children:"\uae30\uc874 \ucf54\ub4dc"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'@Slf4j\npublic class MdcKafkaProducerInterceptor<K, V> implements ProducerInterceptor<K, V> {\n\n  @Override\n  public void configure(Map<String, ?> configs) {\n    log.debug("Configuring MdcKafkaProducerInterceptor with config: {}", configs);\n  }\n\n  @Override\n  public ProducerRecord<K, V> onSend(final ProducerRecord<K, V> rec) {\n    final Headers headers = new RecordHeaders(rec.headers());\n\n    final String traceId = MDC.get("traceId");\n\n    if (traceId != null) {\n      headers.add("traceId", traceId.getBytes(StandardCharsets.UTF_8));\n    }\n\n    return new ProducerRecord<>(rec.topic(), rec.partition(), rec.timestamp(), rec.key(), rec.value(), headers);\n  }\n\n  @Override\n  public void onAcknowledgement(final RecordMetadata metadata, final Exception exception) {\n    if (exception == null) {\n      log.debug("Message sent successfully: {}", metadata);\n    } else {\n      log.error("Message send failed: {}", exception.getMessage(), exception);\n    }\n  }\n\n  @Override\n  public void close() {\n    log.info("Closing MdcKafkaProducerInterceptor");\n  }\n}\n'})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'@Slf4j\npublic class MdcKafkaConsumerInterceptor<K, V> implements ConsumerInterceptor<K, V> {\n\n  @Override\n  public void configure(Map<String, ?> configs) {\n    log.info("Configuring MdcKafkaConsumerInterceptor with config: {}", configs);\n  }\n\n  @Override\n  public ConsumerRecords<K, V> onConsume(ConsumerRecords<K, V> records) {\n    for (final ConsumerRecord<K, V> record : records) {\n      final String traceId = findTraceId(record);\n      if (traceId != null) {\n        MDC.put("traceId", traceId);\n        MDC.put("spanId", SpanId.fromLong(DataKeyGenerator.generateNumericId()));\n      }\n    }\n    return records;\n  }\n\n  @Override\n  public void onCommit(Map<TopicPartition, OffsetAndMetadata> offsets) {\n    log.info("Committing offsets: {}", offsets);\n  }\n\n  @Override\n  public void close() {\n    log.info("Closing MdcKafkaConsumerInterceptor");\n  }\n\n  @Nullable\n  private static <K, V> String findTraceId(ConsumerRecord<K, V> record) {\n    if (record.headers().lastHeader("traceId") != null) {\n      return record.headers().lastHeader("traceId").toString();\n    }\n    return null;\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"\ubb38\uc81c\uc810-1",children:"\ubb38\uc81c\uc810 1"}),"\n",(0,s.jsxs)(n.p,{children:["\ud504\ub85c\ub4c0\uc11c \uc778\ud130\uc149\ud130\uc5d0\uc11c \ub808\ucf54\ub4dc \ub2e8\uc704\ub85c ",(0,s.jsx)(n.code,{children:"traceId"}),"\ub97c \uba54\uc2dc\uc9c0\uc5d0 \uc138\ud305\ud558\uace0\n\ucee8\uc288\uba38 \uc778\ud130\uc149\ud130\uc5d0\uc11c \uba54\uc2dc\uc9c0\uc758 ",(0,s.jsx)(n.code,{children:"traceId"}),"\ub97c \ucd94\ucd9c\ud558\uc5ec ",(0,s.jsx)(n.code,{children:"MDC"}),"\uc5d0 \uc138\ud305\ud558\uace0 \uc788\ub294\ub370,",(0,s.jsx)(n.br,{}),"\n","\ub2e4\uac74\uc758 \ub808\ucf54\ub4dc\uac00 \uc18c\ube44\ub418\ub294 \uacbd\uc6b0\uc5d0 \ud2b9\uc815 \ub808\ucf54\ub4dc\uc758 ",(0,s.jsx)(n.code,{children:"traceId"}),"\uac00 ",(0,s.jsx)(n.code,{children:"MDC"}),"\uc5d0 \uc138\ud305\ub418\uc5b4,\n\ub3d9\uc77c\ud55c \ub808\ucf54\ub4dc\uc784\uc5d0\ub3c4 \ubd88\uad6c\ud558\uace0 \ud504\ub85c\ub4c0\uc11c-\ucee8\uc288\uba38 \uac04\uc5d0 traceId\uac00 \ub2e4\ub974\uac8c \uae30\ub85d\ub418\ub294 \ubb38\uc81c\uac00 \uc788\uc5c8\uc2b5\ub2c8\ub2e4."]}),"\n",(0,s.jsx)(n.p,{children:"\ub610\ud55c, \uc11c\ube44\uc2a4 \ubc30\ud3ec\uc2dc \uc544\ub798\uc640 \uac19\uc774 OpenTelemetry Java Agent \ubc29\uc2dd(Agent Instrumentation)\uc744 \uc801\uc6a9\ud558\uace0 \uc788\ub294\ub370"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:'export JAVA_TOOL_OPTIONS="-javaagent:/home/johny/apps/otel/opentelemetry-javaagent.jar"\n'})}),"\n",(0,s.jsxs)(n.p,{children:["\uc774 \uacbd\uc6b0 \uc790\ub3d9\uc73c\ub85c Kafka \uba54\uc2dc\uc9c0 \ud5e4\ub354\uc5d0 W3C ",(0,s.jsx)(n.code,{children:"traceparent"}),"\uac00 \uc8fc\uc785\ub418\uace0 \uc788\uc74c\uc5d0\ub3c4,",(0,s.jsx)(n.br,{}),"\n","\uc774\ub97c \ud65c\uc6a9\ud558\uc9c0 \uc54a\uace0 \ubcc4\ub3c4\ub85c ",(0,s.jsx)(n.code,{children:"traceId"}),"\ub97c \uba54\uc2dc\uc9c0\uc5d0 \ucd94\uac00\ub85c \uc138\ud305\ud558\uace0 \uc788\ub294\uac83\ub3c4 \ubb38\uc81c\uc600\uc2b5\ub2c8\ub2e4."]}),"\n",(0,s.jsx)(n.h3,{id:"\ubb38\uc81c\uc810-2",children:"\ubb38\uc81c\uc810 2"}),"\n",(0,s.jsxs)(n.p,{children:["\uae30\uc874\uc5d0\ub294 Kafka \ucee8\uc288\uba38\uc5d0\uc11c OpenTelemetry \ucee8\ud14d\uc2a4\ud2b8\ub97c \ucd94\ucd9c\ud558\ub294 \ub85c\uc9c1\uc774 \uc5c6\uc5c8\uc2b5\ub2c8\ub2e4.\n\ud504\ub85c\ub4c0\uc11c\uc5d0\uc11c ",(0,s.jsx)(n.code,{children:"traceparent"})," \ud5e4\ub354\ub97c \ud3ec\ud568\ud574 \uba54\uc2dc\uc9c0\ub97c \ubcf4\ub0b4\ub354\ub77c\ub3c4, \ucee8\uc288\uba38 \uce21\uc5d0\uc11c\ub294 \uc774\ub97c \uc778\uc2dd\ud558\uc9c0 \ubabb\ud558\uace0 \uc0c8\ub85c\uc6b4 ",(0,s.jsx)(n.code,{children:"traceId"}),"\ub85c \uc2a4\ud32c\uc744 \uc2dc\uc791\ud558\uac8c \ub418\uc5c8\uc2b5\ub2c8\ub2e4."]}),"\n",(0,s.jsx)(n.h2,{id:"\ud574\uacb0-\ubc29\ubc95",children:"\ud574\uacb0 \ubc29\ubc95"}),"\n",(0,s.jsx)(n.p,{children:"OpenTelemetry \ucee8\ud14d\uc2a4\ud2b8\ub97c Kafka \uba54\uc2dc\uc9c0 \ud5e4\ub354\uc5d0\uc11c \ucd94\ucd9c\ud558\uace0, \uc774\ub97c \ud604\uc7ac \uc2a4\ub808\ub4dc\uc758 \ucee8\ud14d\uc2a4\ud2b8\ub85c \uc124\uc815\ud558\ub294 \ub85c\uc9c1\uc744 \ucd94\uac00\ud588\uc2b5\ub2c8\ub2e4.\n\uc774\ub97c \uc704\ud574 \uc138 \uac00\uc9c0 \ud575\uc2ec \ucef4\ud3ec\ub10c\ud2b8\ub97c \uad6c\ud604\ud588\uc2b5\ub2c8\ub2e4:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"MessageConsumer"}),": \ucee8\uc288\uba38 \uc778\ud130\ud398\uc774\uc2a4\uc5d0 \uacf5\ud1b5 \ud2b8\ub808\uc774\uc2f1 \ub85c\uc9c1 \ucd94\uac00"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"OpenTelemetryKafkaTracer"}),": \ucee8\ud14d\uc2a4\ud2b8 \ucd94\ucd9c \ubc0f \uc2a4\ucf54\ud504 \uad00\ub9ac"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"OpenTelemetryKafkaExtractor"}),": Kafka \ud5e4\ub354\uc5d0\uc11c traceparent \ucd94\ucd9c"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"\uad6c\ud604-\uc0c1\uc138",children:"\uad6c\ud604 \uc0c1\uc138"}),"\n",(0,s.jsx)(n.h3,{id:"1-messageconsumer-\uc778\ud130\ud398\uc774\uc2a4",children:"1. MessageConsumer \uc778\ud130\ud398\uc774\uc2a4"}),"\n",(0,s.jsxs)(n.p,{children:["\ubaa8\ub4e0 Kafka \ucee8\uc288\uba38\uac00 \uacf5\ud1b5\uc73c\ub85c \uc0ac\uc6a9\ud560 \uc218 \uc788\ub294 \uc778\ud130\ud398\uc774\uc2a4\ub97c \uc815\uc758\ud588\uc2b5\ub2c8\ub2e4.",(0,s.jsx)(n.br,{}),"\n",(0,s.jsx)(n.code,{children:"consume"})," \uba54\uc11c\ub4dc\uc758 \uae30\ubcf8 \uad6c\ud604\uc5d0\uc11c ",(0,s.jsx)(n.code,{children:"OpenTelemetryKafkaTracer"}),"\ub97c \ud1b5\ud574 \uba54\uc2dc\uc9c0\ub97c \ucc98\ub9ac\ud569\ub2c8\ub2e4."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"public interface MessageConsumer<T> {\n\n  default void consume(final List<Message<T>> messages) {\n    OpenTelemetryKafkaTracer.run(messages, this::processMessage);\n  }\n\n  void processMessage(final Message<String> message);\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"2-opentelemetrykafkatracer",children:"2. OpenTelemetryKafkaTracer"}),"\n",(0,s.jsxs)(n.p,{children:["\uac01 \uba54\uc2dc\uc9c0\uc5d0 \ub300\ud574 \ucee8\ud14d\uc2a4\ud2b8\ub97c \ucd94\ucd9c\ud558\uace0, \ud574\ub2f9 \ucee8\ud14d\uc2a4\ud2b8\ub97c \ud604\uc7ac \uc2a4\ub808\ub4dc\uc5d0 \uc124\uc815\ud55c \ud6c4 \ube44\uc988\ub2c8\uc2a4 \ub85c\uc9c1\uc744 \uc2e4\ud589\ud569\ub2c8\ub2e4.",(0,s.jsx)(n.br,{}),"\n",(0,s.jsx)(n.code,{children:"try-with-resources"}),"\ub97c \uc0ac\uc6a9\ud574 \uc2a4\ucf54\ud504\uac00 \uc790\ub3d9\uc73c\ub85c \ub2eb\ud788\ub3c4\ub85d \ubcf4\uc7a5\ud569\ub2c8\ub2e4."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"class OpenTelemetryKafkaTracer {\n  private OpenTelemetryKafkaTracer() {}\n\n  static <T> void run(final List<Message<T>> messages, final Consumer<Message<T>> task) {\n    messages.forEach(msg -> processMessage(msg, task));\n  }\n\n  private static <T> void processMessage(final Message<T> message, final Consumer<Message<T>> task) {\n    final Context context = OpenTelemetryKafkaExtractor.extract(message);\n    try (Scope ignored = context.makeCurrent()) {\n      task.accept(message);\n    }\n  }\n}\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"OpenTelemetryKafkaExtractor.extract(message)"}),": \uba54\uc2dc\uc9c0 \ud5e4\ub354\uc5d0\uc11c \ucee8\ud14d\uc2a4\ud2b8 \ucd94\ucd9c"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"context.makeCurrent()"}),": \ucd94\ucd9c\ud55c \ucee8\ud14d\uc2a4\ud2b8\ub97c \ud604\uc7ac \uc2a4\ub808\ub4dc\uc5d0 \uc124\uc815"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"try-with-resources"}),": \uc2a4\ucf54\ud504\uac00 \uc790\ub3d9\uc73c\ub85c \ub2eb\ud600 \uba54\ubaa8\ub9ac \ub204\uc218 \ubc29\uc9c0"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"3-opentelemetrykafkaextractor",children:"3. OpenTelemetryKafkaExtractor"}),"\n",(0,s.jsxs)(n.p,{children:["Kafka \uba54\uc2dc\uc9c0 \ud5e4\ub354\uc5d0\uc11c ",(0,s.jsx)(n.code,{children:"traceparent"}),"\ub97c \ucd94\ucd9c\ud558\uc5ec OpenTelemetry ",(0,s.jsx)(n.code,{children:"Context"}),"\ub85c \ubcc0\ud658\ud569\ub2c8\ub2e4. Kafka native headers\ub97c \uc6b0\uc120\uc801\uc73c\ub85c \ud655\uc778\ud558\uace0, \uc5c6\uc744 \uacbd\uc6b0 Spring Message headers\uc5d0\uc11c \ucd94\ucd9c\ud569\ub2c8\ub2e4."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'public final class OpenTelemetryKafkaExtractor {\n\n  private static final String TRACE_PARENT = "traceparent";\n\n  private static final TextMapGetter<Headers> KAFKA_HEADERS_GETTER = new TextMapGetter<>() {\n    @Override\n    public Iterable<String> keys(final Headers carrier) {\n      final List<String> keys = new ArrayList<>();\n      carrier.forEach(h -> keys.add(h.key()));\n      return keys;\n    }\n\n    @Override\n    public String get(final Headers carrier, @NonNull final String key) {\n      if (Objects.isNull(carrier)) {\n        return null;\n      }\n      final Header h = carrier.lastHeader(key);\n      if (Objects.isNull(h) || Objects.isNull(h.value())) {\n        return null;\n      }\n      return new String(h.value(), StandardCharsets.UTF_8);\n    }\n  };\n\n  private OpenTelemetryKafkaExtractor() {}\n\n  /**\n   * Extracts an OpenTelemetry {@link Context} from a Spring {@link Message}.\n   *\n   * <p>Prefers native Kafka headers first (looking for {@code traceparent}) and\n   * falls back to Spring message headers.</p>\n   *\n   * @param <T> the payload type of the message\n   * @param message the message to read headers from; may be {@code null}\n   * @return the extracted {@link Context}; if {@code message} is {@code null}, returns {@link Context#current()}\n   */\n  public static <T> Context extract(final Message<T> message) {\n    if (Objects.isNull(message)) {\n      return Context.current();\n    }\n    // 1) Kafka native headers \uc6b0\uc120\n    final Object nativeHeaders = message.getHeaders().get(KafkaHeaders.NATIVE_HEADERS);\n    if (nativeHeaders instanceof Headers headers && Objects.nonNull(headers.lastHeader(TRACE_PARENT))) {\n      return GlobalOpenTelemetry.getPropagators()\n                                .getTextMapPropagator()\n                                .extract(Context.current(), headers, KAFKA_HEADERS_GETTER);\n    }\n    // 2) Fallback: Spring Message \ud5e4\ub354\uc5d0\uc11c \ucd94\ucd9c\n    return GlobalOpenTelemetry.getPropagators()\n                              .getTextMapPropagator()\n                              .extract(Context.current(), message, springMessageGetter());\n  }\n\n  private static <T> TextMapGetter<Message<T>> springMessageGetter() {\n    return new TextMapGetter<>() {\n      @Override\n      public Iterable<String> keys(@NonNull final Message<T> carrier) {\n        return carrier.getHeaders().keySet();\n      }\n\n      @Override\n      public String get(final Message<T> carrier, @NonNull final String key) {\n        if (Objects.isNull(carrier)) {\n          return null;\n        }\n        final Object v = carrier.getHeaders().get(key);\n        if (Objects.isNull(v)) {\n          return null;\n        }\n        if (v instanceof byte[] b) {\n          return new String(b, StandardCharsets.UTF_8);\n        }\n        return v.toString();\n      }\n    };\n  }\n}\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Kafka native headers \uc6b0\uc120: ",(0,s.jsx)(n.code,{children:"KafkaHeaders.NATIVE_HEADERS"}),"\uc5d0\uc11c ",(0,s.jsx)(n.code,{children:"traceparent"})," \ud5e4\ub354\ub97c \uba3c\uc800 \ud655\uc778"]}),"\n",(0,s.jsx)(n.li,{children:"Fallback \uba54\ucee4\ub2c8\uc998: Kafka native headers\uc5d0 \uc5c6\uc744 \uacbd\uc6b0 Spring Message headers\uc5d0\uc11c \ucd94\ucd9c"}),"\n",(0,s.jsx)(n.li,{children:"TextMapGetter \uad6c\ud604: OpenTelemetry\uc758 \ud45c\uc900 \uc778\ud130\ud398\uc774\uc2a4\ub97c \uad6c\ud604\ud558\uc5ec \ud5e4\ub354 \uac12\uc744 \uc77d\uc74c"}),"\n",(0,s.jsx)(n.li,{children:"\ubc14\uc774\ud2b8 \ubc30\uc5f4 \ucc98\ub9ac: Kafka \ud5e4\ub354\ub294 \ubc14\uc774\ud2b8 \ubc30\uc5f4\uc774\ubbc0\ub85c UTF-8\ub85c \ub514\ucf54\ub529"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"\uc2e4\uc81c-\uc801\uc6a9-\uc608\uc2dc",children:"\uc2e4\uc81c \uc801\uc6a9 \uc608\uc2dc"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"SchedulerMessageConsumer"}),"\ub294 ",(0,s.jsx)(n.code,{children:"MessageConsumer"})," \uc778\ud130\ud398\uc774\uc2a4\ub97c \uad6c\ud604\ud558\uc5ec \uc790\ub3d9\uc73c\ub85c \ud2b8\ub808\uc774\uc2f1\uc774 \uc801\uc6a9\ub429\ub2c8\ub2e4."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'public class SchedulerMessageConsumer implements MessageConsumer<String> {\n  private final ImmediatePushService immediatePushService;\n\n  @KafkaListener(topics = EventMessageConstants.TOPIC_SINGLE_PUSH_EXTRACT, batch = "false")\n  public void consumeSingleMessage(final Message<String> message, final Acknowledgment acknowledgment) {\n    try {\n      consume(List.of(message));\n    } catch (Exception e) {\n      log.error("fail kafka consume. topic: {}, message: {}", EventMessageConstants.TOPIC_SINGLE_PUSH_EXTRACT, message, e);\n    } finally {\n      acknowledgment.acknowledge();\n    }\n  }\n\n  @Override\n  public void processMessage(final Message<String> message) {\n    Optional.ofNullable(MessageUtil.deserialize(message, SinglePushExtractEventMessage.class))\n            .ifPresent(dto -> {\n              log.debug("SinglePushExtractEvent. event={}", NscConfig.MAPPER.valueToTree(dto).toString());\n              immediatePushService.execute(dto);\n              ThreadUtil.sleep(200, TimeUnit.MILLISECONDS);\n            });\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"\ub3d9\uc791-\ud750\ub984",children:"\ub3d9\uc791 \ud750\ub984"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"@KafkaListener"}),"\uac00 \uba54\uc2dc\uc9c0\ub97c \uc218\uc2e0"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"consume(List.of(message))"})," \ud638\ucd9c \u2192 ",(0,s.jsx)(n.code,{children:"MessageConsumer"}),"\uc758 \uae30\ubcf8 \uad6c\ud604 \uc2e4\ud589"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"OpenTelemetryKafkaTracer.run()"})," \u2192 \uba54\uc2dc\uc9c0 \ud5e4\ub354\uc5d0\uc11c \ucee8\ud14d\uc2a4\ud2b8 \ucd94\ucd9c \ubc0f \uc124\uc815"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"processMessage()"})," \uc2e4\ud589 \u2192 \ucd94\ucd9c\ub41c \ucee8\ud14d\uc2a4\ud2b8 \ud558\uc5d0\uc11c \ube44\uc988\ub2c8\uc2a4 \ub85c\uc9c1 \uc218\ud589"]}),"\n",(0,s.jsx)(n.li,{children:"\ubaa8\ub4e0 \uc2a4\ud32c\uc774 \ub3d9\uc77c\ud55c traceId\ub85c \uc5f0\uacb0\ub428"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"\ub9c8\uce58\uba70",children:"\ub9c8\uce58\uba70"}),"\n",(0,s.jsx)(n.p,{children:"Kafka \uae30\ubc18 \uc11c\ube44\uc2a4\uc5d0\uc11c TraceId \ubd88\uc77c\uce58\ub294 \ub300\ubd80\ubd84 \ube44\ud45c\uc900 \uc804\ud30c \ubc29\uc2dd(MDC \uae30\ubc18 \ucee4\uc2a4\ud140 \ud5e4\ub354)\uacfc\nOpenTelemetry \ucee8\ud14d\uc2a4\ud2b8 \ucd94\ucd9c\xb7\uc801\uc6a9\uc758 \ubd80\uc7ac\uac00 \uacb0\ud569\ub420 \ub54c \ubc1c\uc0dd\ud569\ub2c8\ub2e4."}),"\n",(0,s.jsx)(n.p,{children:"\uc774\ubc88 \uac1c\uc120\uc744 \ud1b5\ud574"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"OpenTelemetry Java Agent"}),"\uac00 \uc790\ub3d9\uc73c\ub85c \uc8fc\uc785\ud558\ub294 ",(0,s.jsx)(n.code,{children:"W3C traceparent"})," \ud5e4\ub354\ub97c \ud45c\uc900 \uc804\ud30c \uc218\ub2e8\uc73c\ub85c \ud1b5\uc77c\ud558\uace0,"]}),"\n",(0,s.jsx)(n.li,{children:"Consumer \uce21\uc5d0\uc11c \ucee8\ud14d\uc2a4\ud2b8\ub97c \uc815\ud655\ud788 \ucd94\ucd9c\ud574 \uc2a4\ub808\ub4dc \ucee8\ud14d\uc2a4\ud2b8\ub85c \uc801\uc6a9\ud558\ub294 \ucc98\ub9ac \uacc4\uce35\uc744 \ub3c4\uc785\ud568\uc73c\ub85c\uc368"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Producer \u2192 Consumer \uc804 \uad6c\uac04\uc5d0\uc11c \uc77c\uad00\ub41c ",(0,s.jsx)(n.code,{children:"TraceId"}),"\uc640 ",(0,s.jsx)(n.code,{children:"Span"})," \uad6c\uc870\ub97c \ud655\ubcf4\ud560 \uc218 \uc788\uc5c8\uace0,\n\uadf8 \uacb0\uacfc \ubd84\uc0b0 \ud2b8\ub79c\uc7ad\uc158\uc758 \ucd94\uc801 \uc815\ud655\ub3c4, \uc7a5\uc560 \ubd84\uc11d \uc18d\ub3c4, \uba54\uc2dc\uc9c0 \ud750\ub984 \uac00\uc2dc\uc131\uc774 \ud06c\uac8c \uac1c\uc120\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]})]})}function g(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>c});var a=r(6540);const s={},t=a.createContext(s);function i(e){const n=a.useContext(t);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),a.createElement(t.Provider,{value:n},e.children)}}}]);